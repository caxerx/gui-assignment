<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Search - Library System</title>
</head>

<body>
    <div id="app">
        <v-app id="inspire">
            <v-toolbar color="primary" app clipped-left dark>
                <v-toolbar-title>Library System</v-toolbar-title>
                <v-spacer></v-spacer>
                <v-layout justify-end align-center pt-3 pr-1>
                    <div>
                        <p class="text-xs-left">
                            Logged in as <b class="red--grey">{{user.username}}</b>
                            <br/> {{user.role}}
                        </p>
                    </div>
                </v-layout>
                <div>
                    <v-tooltip bottom>
                        <v-btn @click="logout" slot="activator" icon>
                            <v-icon>exit_to_app</v-icon>
                        </v-btn>
                        <span>Logout</span>
                    </v-tooltip>
                </div>
            </v-toolbar>
            <v-navigation-drawer app clipped>
                <v-layout column>
                    <v-flex xs12>
                        <v-text-field prepend-inner-icon="search" hide-details single-line solo v-model="keyword"></v-text-field>
                    </v-flex>
                    <v-flex xs12 mt-3 px-3>
                        <v-layout>
                            <span class="body-2">Filter by category</span>
                            <v-spacer></v-spacer>
                            <a small flat @click="allClicked">{{allText}}</a>
                        </v-layout>
                        <div v-for="c in categories">
                            <v-checkbox :label="c" hide-details v-model="filter" :value="c.toLowerCase()"></v-checkbox>
                        </div>
                    </v-flex>
                </v-layout>
            </v-navigation-drawer>
            <v-content>

                <div style="position:fixed; z-index:10; width:100%">
                    <v-toolbar flat>
                        <template v-if="pagination.totalItems > 0">
                            {{pageMin}} - {{pageMax}} of total {{pagination.totalItems}}
                        </template>
                        <template v-else>
                            No
                        </template> results
                        <template v-if="keyword && keyword != ''">
                            for "{{keyword}}"
                        </template>
                    </v-toolbar>
                    <v-divider></v-divider>
                </div>

                <v-container mt-5>

                    <v-data-iterator column :items="filteredBooks" :pagination.sync="pagination" content-tag="div" :search="keyword">
                        <div slot="item" slot-scope="props">
                            <v-card class="mt-4">
                                <v-container>
                                    <v-layout row>
                                        <v-flex>
                                            <v-layout row align-center justify-center>
                                                <v-img :src="props.item.cover" max-height="300" max-width="300" contain />
                                            </v-layout>
                                            <v-layout column pt-3 align-center>
                                                <v-flex>
                                                    <v-chip label small color="success" text-color="white" disabled v-if="props.item.available === true">
                                                        Available
                                                    </v-chip>
                                                    <v-chip label small color="error" text-color="white" disabled v-else>
                                                        Not Available
                                                    </v-chip>
                                                </v-flex>
                                            </v-layout>
                                        </v-flex>
                                        <v-flex xs6 lg10 pl-4>
                                            <v-layout column>
                                                <v-flex xs12>
                                                    <v-chip label small outline color="error" disabled v-if="props.item.category === 'book'">Book</v-chip>
                                                    <v-chip label small outline color="info" disabled v-else-if="props.item.category === 'software'">Software</v-chip>
                                                    <v-chip label small outline color="success" disabled v-else-if="props.item.category === 'magazine'">Magazine</v-chip>
                                                    <v-chip label small outline color="grey" disabled v-else>Unknown</v-chip>

                                                    <a class="subheading">{{props.item.title}}</a>
                                                    <p>
                                                        <span class="caption">by {{props.item.author}}</span>
                                                        <br />
                                                        <span class="caption">Code: {{props.item.id}}</span>
                                                    </p>
                                                </v-flex>
                                                <v-flex xs12 pb-3>
                                                    <v-divider></v-divider>
                                                </v-flex>

                                                <v-flex xs12>
                                                    <p class="body-2">{{props.item.description}}</p>
                                                </v-flex>
                                            </v-layout>
                                        </v-flex>

                                    </v-layout>
                                </v-container>
                            </v-card>
                        </div>
                    </v-data-iterator>
                </v-container>
            </v-content>
        </v-app>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js "></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js "></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js "></script>
<script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.js"></script>
<script>
    new Vue({
        el: '#app',
        data: () => ({
            uncheck: false,
            filter: [],
            filteredBooks: [],
            categories: ["Book", "Software", "Magazine"],
            pagination: {},
            keyword: "",
            books: [],
            user: {}
        }),
        created() {
            let user = localStorage.getItem("loggedInAs");
            if (!user) {
                window.location.href = "./index.html";
                return;
            }
            this.user = JSON.parse(user);

            let bk = axios.get("./data/books.json").then(resp => {
                resp.data.forEach(item => {
                    this.books.push(item);
                })
            })


            let sf = axios.get("./data/software.json").then(resp => {
                resp.data.forEach(item => {
                    this.books.push(item);
                })
            })

            let mz = axios.get("./data/magazines.json").then(resp => {
                resp.data.forEach(item => {
                    this.books.push(item);
                })
            })

            let urlParams = new URLSearchParams(window.location.search);
            this.keyword = urlParams.get('keyword');

            Promise.all([bk, sf, mz]).then(() => {
                this.allClicked()
            })
        },
        methods: {
            allClicked() {
                if (this.filter.length >= this.categories.length) {
                    this.filter.splice(0, this.filter.length)
                } else {
                    this.filter.splice(0, this.filter.length)
                    this.categories.forEach(i => {
                        this.filter.push(i.toLowerCase());
                    })
                }
            },
            logout() {
                window.location.href = `./login.html`
            }
        },
        watch: {
            filter() {
                this.filteredBooks.splice(0, this.filteredBooks.length);
                this.books.forEach(b => {
                    if (this.filter.includes(b.category.toLowerCase())) {
                        this.filteredBooks.push(b)
                    }
                })
            },
            page() {
                window.scrollTo(0, 0);
            }
        },
        computed: {
            page() {
                return this.pagination.page;
            },
            allText() {
                if (this.filter.length >= this.categories.length) {
                    return "Unselect All"
                }
                return "Select All"
            },
            pageMin() {
                let page = this.pagination.page - 1
                let each = this.pagination.rowsPerPage - 0
                let total = this.pagination.totalItems - 0
                return page * each + 1;
            },
            pageMax() {
                let max = this.pageMin + this.pagination.rowsPerPage - 1;
                return max > this.pagination.totalItems ? this.pagination.totalItems : max
            }
        }
    })
</script>

</html>

</html>